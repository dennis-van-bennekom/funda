"use strict";var config=function(){return{FUNDA_KEY:"e2d60e885b8742d4b0648300e3703bd7",FUNDA_SEARCH_URL:"http://funda.kyrandia.nl/feeds/Aanbod.svc",GOOGLE_KEY:"AIzaSyAyplpUsQaEcx7sfRzKwaX2EoAWMqFg7L4"}}(),store=function(){var e=function(e,t){localStorage.setItem(e,JSON.stringify(t))},t=function(e){return JSON.parse(localStorage.getItem(e))};return{set:e,get:t}}(),api=function(){var e=function(e,t,n){fetch("https://maps.googleapis.com/maps/api/geocode/json?latlng="+e+","+t+"&key="+config.GOOGLE_KEY).then(function(e){return e.json()}).then(function(e){var t=e.results[0].address_components,o=t.filter(function(e){return e.types.indexOf("postal_code")>=0});o=o[0].long_name;var r=t.filter(function(e){return e.types.indexOf("administrative_area_level_2")>=0});r=r[0].long_name,o=o.replace(" ",""),r=r.replace(" ","-"),n(o,r)})},t=function(e,t,n){var o=store.get("PRICE_MIN"),r=store.get("PRICE_MAX");fetch(config.FUNDA_SEARCH_URL+"/json/"+config.FUNDA_KEY+"/?type=koop&zo=/"+t+"/"+e+"/+1km/"+o+"-"+r+"&page=1&pagesize=10").then(function(e){return e.json()}).then(function(e){n(e.Objects)})},n=function(e,t){fetch(config.FUNDA_SEARCH_URL+"/json/detail/"+config.FUNDA_KEY+"/koop/"+e).then(function(e){return e.json()}).then(function(e){t(e)})},o=function(e,t,n){var o=new google.maps.DistanceMatrixService;o.getDistanceMatrix({origins:e,destinations:t,travelMode:google.maps.TravelMode[store.get("TRANSPORT")]},function(e,t){var o=e.rows[0].elements.map(function(e){return(e.status="OK")?{distance:e.distance.text,duration:e.duration.text}:{}});n(o)})};return{getLocation:e,getObjects:t,getObject:n,getDistanceAndTime:o}}(),controller=function(){var e=function(){a("loading",{message:"Wachten op locatie..."}),navigator.geolocation?navigator.geolocation.getCurrentPosition(function(e){var t=e.coords.latitude,n=e.coords.longitude;api.getLocation(t,n,function(e,o){a("loading",{message:"Woningen zoeken..."}),api.getObjects(e,o,function(e){var o=new google.maps.LatLng(t,n),r=[],i=[];e.forEach(function(e){r.push(o),i.push(e.Woonplaats+" "+e.Adres)}),api.getDistanceAndTime(r,i,function(t){e=e.map(function(e,n){return e.Distance=t[n].distance,e.Duration=t[n].duration,e}),a("home",e)})})})},function(){t()}):t()},t=function(){a("fallback",{},function(){document.getElementById("fallback-form").addEventListener("submit",function(e){var t=e.target[0].value.trim();api.getObjects("",t,function(e){var t="Amsterdam",n=[],o=[];e.forEach(function(e){n.push(t),o.push(e.Woonplaats+" "+e.Adres)}),api.getDistanceAndTime(n,o,function(t){e=e.map(function(e,n){return e.Distance=t[n].distance,e.Duration=t[n].duration,e}),a("home",e)})}),e.preventDefault()})})},n=function(){var e=store.get("PRICE_MIN")||0,t=store.get("PRICE_MAX")||1e6,n=store.get("TRANSPORT")||"WALKING";a("settings",{min:e,max:t},function(){var o=document.getElementById("form"),r=document.getElementById(n.toLowerCase());r.checked=!0,o.addEventListener("submit",function(n){n.preventDefault();var o=n.target.elements;[].forEach.call(o,function(n){"min"===n.name?e=parseInt(n.value):"max"===n.name&&(t=parseInt(n.value)),"radio"===n.type&&n.checked&&store.set("TRANSPORT",n.id.toUpperCase())}),t>e&&(store.set("PRICE_MIN",e),store.set("PRICE_MAX",t))})})},o=function(e){a("loading",{message:"Woning ophalen..."}),api.getObject(e,function(t){a("object",t,function(){var n=document.getElementById("save"),o=store.get("SAVED"),r=!1;o.forEach(function(t){t.InternalId===e&&(r=!0)}),r&&n.classList.add("liked"),n.addEventListener("click",function(){r?(r=!1,n.classList.remove("liked"),o.forEach(function(t,n){t.InternalId===e&&o.splice(n,1)}),store.set("SAVED",o)):(r=!0,n.classList.add("liked"),o.push(t),store.set("SAVED",o))}),navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var n=e.coords.latitude,o=e.coords.longitude,r=new google.maps.DirectionsRenderer,a=new google.maps.DirectionsService,i=new google.maps.LatLng(n,o),s=t.Plaats+" "+t.Adres,c={zoom:16,center:i},u=new google.maps.Map(document.getElementById("map"),c);r.setMap(u),r.setPanel(document.getElementById("panel"));var l={origin:i,destination:s,travelMode:google.maps.TravelMode[store.get("TRANSPORT")]};a.route(l,function(e,t){"OK"===t&&r.setDirections(e)})})})})},r=function i(){var i=store.get("SAVED"),e=store.get("SAVED_SORT"),t=function(){a("saved",i,function(){var t=document.querySelectorAll(".sort"),o=document.getElementById(e);o.classList.add("selected"),[].forEach.call(t,function(o){o.addEventListener("click",function(r){store.set("SAVED_SORT",r.target.id),e=r.target.id,[].forEach.call(t,function(e){e.classList.remove("selected")}),o.classList.add("selected"),n()})})})},n=function(){switch(e){case"prijs_aflopend":i=store.get("SAVED"),i=_.sortBy(i,"KoopPrijs").reverse(),t();break;case"prijs_oplopend":i=store.get("SAVED"),i=_.sortBy(i,"KoopPrijs"),t();break;case"recent":i=store.get("SAVED"),t()}};n()},a=function(e,t,n){var o=document.getElementById("render-target");fetch("scripts/templates/"+e+".mst").then(function(e){return e.text()}).then(function(e){o.innerHTML=Mustache.render(e,t),n&&n()})};return{home:e,settings:n,object:o,saved:r}}(),router=function(){var e=function(){routie({"":function(){controller.home()},settings:function(){controller.settings()},"object/:guid":function(e){controller.object(e)},saved:function(){controller.saved()}})};return{init:e}}();!function(){store.set("PRICE_MIN",store.get("PRICE_MIN")||0),store.set("PRICE_MAX",store.get("PRICE_MAX")||1e6),store.set("TRANSPORT",store.get("TRANSPORT")||"WALKING"),store.set("SAVED",store.get("SAVED")||[]),store.set("SAVED_SORT",store.get("SAVED_SORT")||"recent"),router.init()}();